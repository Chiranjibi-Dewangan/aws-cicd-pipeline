name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ENVIRONMENT: dev

jobs:
  build-and-test:
    name: Build and Test Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build Docker image
      working-directory: ./app
      run: docker build -t app:test .
    
    - name: Test Docker image
      run: |
        docker run -d -p 3000:3000 --name test-app app:test
        sleep 10
        curl -f http://localhost:3000/health || exit 1
        docker stop test-app
        echo "âœ… Image test passed"

  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
    
    outputs:
      ecr_repository: ${{ steps.outputs.outputs.ecr_repository }}
      alb_dns: ${{ steps.outputs.outputs.alb_dns }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.6.0
        terraform_wrapper: false
    
    - name: Terraform Init
      working-directory: ./terraform
      run: terraform init
    
    - name: Terraform Validate
      working-directory: ./terraform
      run: terraform validate
    
    - name: Terraform Plan
      working-directory: ./terraform
      run: terraform plan -out=tfplan
    
    - name: Terraform Apply
      working-directory: ./terraform
      run: terraform apply -auto-approve tfplan
    
    - name: Get Terraform Outputs
      id: outputs
      working-directory: ./terraform
      run: |
        ECR_REPO=$(terraform output -raw ecr_repository_url)
        ALB_DNS=$(terraform output -raw alb_dns_name)
        echo "ecr_repository=${ECR_REPO}" >> $GITHUB_OUTPUT
        echo "alb_dns=${ALB_DNS}" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ ECR Repository: ${ECR_REPO}"
        echo "ğŸŒ ALB DNS: ${ALB_DNS}"

  push-image:
    name: Push Image to ECR
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
    
    - name: Build and push image
      env:
        ECR_REPO: ${{ needs.deploy-infrastructure.outputs.ecr_repository }}
      run: |
        echo "Building and pushing to: ${ECR_REPO}"
        cd app
        docker build -t ${ECR_REPO}:latest .
        docker push ${ECR_REPO}:latest
        echo "âœ… Image pushed successfully"
    
    - name: Trigger instance refresh
      run: |
        ASG_NAME="${{ env.ENVIRONMENT }}-app-asg"
        
        # Check if ASG exists
        if aws autoscaling describe-auto-scaling-groups --auto-scaling-group-names ${ASG_NAME} &>/dev/null; then
          echo "Triggering instance refresh for ${ASG_NAME}..."
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name ${ASG_NAME} \
            --preferences '{"MinHealthyPercentage": 50, "InstanceWarmup": 300}'
          echo "âœ… Instance refresh triggered"
        else
          echo "â­ï¸  Skipping instance refresh (first deployment - instances are launching)"
        fi
    
    - name: Display deployment info
      env:
        ALB_DNS: ${{ needs.deploy-infrastructure.outputs.alb_dns }}
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸš€ DEPLOYMENT SUCCESSFUL"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Application URL:"
        echo "http://${ALB_DNS}"
        echo ""
        echo "Health Check:"
        echo "http://${ALB_DNS}/health"
        echo ""
        echo "â³ Note: First deployment takes ~5 minutes for instances to be healthy"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
